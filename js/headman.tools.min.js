function is_exist(item){
  return (typeof(item) != "undefined" && item !== null);
}
function setSelectionRange(input, selectionStart, selectionEnd) {
  if (input.setSelectionRange) {
    input.focus();
    input.setSelectionRange(selectionStart, selectionEnd);
  }
  else if (input.createTextRange) {
    var range = input.createTextRange();
    range.collapse(true);
    range.moveEnd('character', selectionEnd);
    range.moveStart('character', selectionStart);
    range.select();
  }
}
function setCaretToPos (input, pos) {
  setSelectionRange(input, pos, pos);
}
$(document).on('change', '.lesson.custom-select', function(e) {
  var item = $("#inputRoom" + $(this).attr("id")[$(this).attr("id").length - 1]);
  item.val("");
  if($(this).val() != -1) {
    setTimeout(function () {
      item.focus();
    }, 500);
  }
});
$('#saveChanges').on('click', function(e) {
  var outlesson = [];
  var listItems = [];
  $('#saveChanges').prop("disabled", true);
  $('#saveChanges').html('<div class="spinner-border text-info" role="status"><span class="sr-only">Загрузка...</span></div>');
  $("#editBody select[id^='inputLesson']").each(function(item) {
    var roomId = "#inputRoom" + this.id[this.id.length - 1];
    listItems.push({
      lesson: "#" + this.id,
      room: roomId
    });

    $(roomId).removeClass("is-invalid");
    $(roomId).prop("disabled", true);
    $("#" + this.id).prop("disabled",true);
    outlesson.push({
      'lid': $(this).data('lid'),
      'lesson-id':this.value,
      'num-lesson':this.id[this.id.length - 1],
      'num-room':$("#inputRoom" + this.id[this.id.length - 1]).val()
    });
  });
  $.post("/proc/headman.php", { action: 'putLesson', lessons: outlesson, day: $('#saveChanges').data('day')},
   function(data) {
     window.location.href = "/";
   }, "json").fail(function(data) {
     if(data.status == 400){
       data.responseJSON.errors.forEach(error => {
         switch (error.error_code) {
           case 1:case 2:case 3:case 4:{
             setTimeout(function () {
               $('#editScheduleModal').modal('hide');
             }, 500);
             showError(error.text, true);
           }break;
           case 5:{
             $("#validationRoom" + error.item['num-lesson']).html(error.text);
             $("#inputRoom" + error.item['num-lesson']).addClass("is-invalid");
           }break;
           default:{
             setTimeout(function () {
               $('#editScheduleModal').modal('hide');
             }, 500);
             showError(data.status, false);
           }break;
         }
       });
     }else {
       setTimeout(function () {
         $('#editScheduleModal').modal('hide');
       }, 500);
       showError(data.status, false);
     }
     return false;
   }).always(function() {
     listItems.forEach((item, i) => {
       $(item.lesson).prop("disabled", false);
       $(item.room).prop("disabled", false);
     });
     $('#saveChanges').prop("disabled", false);
     $('#saveChanges').html('Сохранить');
    });
});
$('.button-edit-day').on('click', function(e) {
  if(!$(e.currentTarget).hasClass('disabled')){
    $('#editBody').html('<div class="d-flex justify-content-center"><div class="spinner-border text-info" role="status"><span class="sr-only">Загрузка...</span></div></div>');
    $('#saveChanges').html("Загрузка...");
    $('#saveChanges').prop('disabled', true);
    var dayToEdit = $(e.currentTarget).data('day');
    $('#saveChanges').data('day', dayToEdit);
    var gid = $(e.currentTarget).data('gid');
    $('#modalEditLabel').html($(e.currentTarget).parent().parent().find('h4').html());
    $.get("/proc/headman.php", { action: 'loadLessons', day: dayToEdit },
     function(data) {
       $('#editBody').html('');
       items = [data.calls];
       for (var i = 0; i < data.calls; i++) {
         items[i] = {'id': "-1", 'num-lesson': "-1", 'num-room': ""};
       }
       data.target.forEach((item, i) => {
         items[item['num-lesson'] - 1] = item;
       });
       for (var i = 0; i < data.calls; i++) {
         var item = items[i];
         var out = '<div class="form-row px-3">' +
           '<div class="form-group col-8">' +
             '<label for="inputLesson' + (i + 1) + '">' + (i + 1) + ' пара</label>' +
             '<select class="lesson custom-select" data-lid="' + item['id'] + '" id="inputLesson' + (i + 1) + '">' +
               '<option value="-1">Пары нет</option>';
               data.lessons.forEach((lesson, l) => {
                 var selected = (item["lesson-id"] === lesson.id) ? "selected":"";
                 out += '<option value="' + lesson.id + '"' + selected + '>' + lesson.name + '</option>';
               });
          out+='</select>'+
           '</div>' +
           '<div class="form-group col-4">' +
             '<label for="inputRoom' + (i + 1) + '">Аудитория</label>' +
             '<input type="number" id="inputRoom' + (i + 1) + '" aria-describedby="validationRoom' + (i + 1) + '" max="9999" step="1" min=1 class="form-control text-center" value="' + item["num-room"] + '">' +
             '<div id="validationRoom' + (i + 1) + '" class="invalid-feedback">dasd</div>'+
           '</div>' +
         '</div>';
         $('#editBody').html($('#editBody').html() + out);
       }
       $('#saveChanges').html("Сохранить");
       $('#saveChanges').prop('disabled', false);
       /**/
     }, "json").fail(function(data) {
       setTimeout(function () {
         $('#editScheduleModal').modal('hide');
       }, 500);
       showError(data.status, false);
       return false;
     });
  }
});
$('.action-lesson').on('click', function(e) {
  var action = $(this).data('action');
  $('#selectTeacher').val('-1');
  $('#inputLName').val('');
  $("#inputLName").removeClass("is-invalid");
  $("#selectTeacher").removeClass("is-invalid");
  $('#saveLessonChanges').attr('data-action', action);
  $('#saveLessonChanges').attr('data-lid', ($(this).data('lid')) ? $(this).data('lid') : '-1');
  $('#modalEditLabel').text((action == 'add')?'Добавляем урок':'Редактируем урок');
  $('#saveLessonChanges').html("Загрузка...");
  $('#saveLessonChanges').prop('disabled', true);
  if(action == 'edit'){
    var tid = $(this).data('tid');
    var name = $(this).data('name');
  }
  $('#selectTeacher').html("");
  $('#selectTeacher').append('<option value="-1">Не выбрано</option>');
  $('#inputLName').prop('disabled', true);
  $('#selectTeacher').prop('disabled', true);
  $.get("/proc/headman.php", { action: 'getTeachers' },
   function(data) {
     data.forEach((item, i) => {
       $('#selectTeacher').append('<option value="' + item.id + '">' + item.name + '</option>');
     });
     $('#selectTeacher').val((action == 'add')?'-1':tid);
     $('#inputLName').val((action == 'add')?'':name);
     $('#saveLessonChanges').html((action == 'add')?'Добавить':'Изменить');
     $('#saveLessonChanges').prop('disabled', false);
     $('#inputLName').prop('disabled', false);
     $('#selectTeacher').prop('disabled', false);
     setTimeout(function () {
       $('#inputLName').focus();
     }, 500);
   }, "json").fail(function(data) {
     setTimeout(function () {
       $('#LessonModal').modal('hide');
     }, 500);
     showError(data.status, false);
     return false;
   });
});
$('#saveLessonChanges').on('click', function(e) {
  var action = $(this).data('action');
  $("#inputLName").removeClass("is-invalid");
  $("#selectTeacher").removeClass("is-invalid");
  $('#saveLessonChanges').html("Загрузка...");
  $('#saveLessonChanges').prop('disabled', true);
  $('#inputLName').prop('disabled', true);
  $('#selectTeacher').prop('disabled', true);
  $.post("/proc/headman.php", { action: 'addLesson', lesson: $('#inputLName').val(), tid: $('#selectTeacher').val(), lid: $('#saveLessonChanges').data('lid')},
   function(data) {

     setTimeout(function () {
       $('#LessonModal').modal('hide');
     }, 500);
     location.reload();
   }, "json").fail(function(data) {
     if(data.status == 400){
       data.responseJSON.errors.forEach(error => {
         switch (error.error_code) {
           case 1:{
             $("#invalidLName").html(error.text);
             $("#inputLName").addClass("is-invalid");
           }break;
           case 2:{
             $("#invalidTeacher").html(error.text);
             $("#selectTeacher").addClass("is-invalid");
           }break;
           default:{
             setTimeout(function () {
               $('#LessonModal').modal('hide');
             }, 500);
             showError(data.status, false);
           }break;
         }
       });
     }else {
       setTimeout(function () {
         $('#LessonModal').modal('hide');
       }, 500);
       showError(data.status, false);
     }
     return false;
   }).always(function() {
     $('#saveLessonChanges').html((action == 'add')?'Добавить':'Изменить');
     $('#saveLessonChanges').prop('disabled', false);
     $('#inputLName').prop('disabled', false);
     $('#selectTeacher').prop('disabled', false);
    });

});
$('.remove-action').on('click', function(e) {
  $('#removeSubmit').prop('disabled', true);
  $('#removeSubmit').text("Загрузка...");
  $('#removeSubmit').attr('data-lid', '-1');
  $('#removeSubmit').attr('data-tid', '-1');
  $('#removeSubmit').attr('data-sid', '-1');
  $('#removeSubmit').attr('data-action', $(this).data('action'));
  $('#removeBody').slideUp('fast');
  var action = $(this).data('action');
  $.get("/proc/headman.php", { action: 'preRemove', lid: $(e.currentTarget).data('lid'), tid: $(e.currentTarget).data('tid'), sid: $(e.currentTarget).data('sid')},
   function(data) {
     $('#removeSubmit').text("Удалить");
     $('#removeSubmit').prop('disabled', false);
     if(action == 'lesson'){
       $('#removeBody').html('Вы действительно ходите удалить урок <b>' + $(e.currentTarget).data('name') + '</b>?');
       if(data.schedules > 0) $('#removeBody').html($('#removeBody').html() + ' Так же будет ' + getEnding(data.schedules, ['удалён','удалено','удалено']) +' <b>' + data.schedules + '</b> '+ getEnding(data.schedules, ['связанный урок','связанных урока','связанных уроков']) + ' из расписания.');
       $('#removeSubmit').attr('data-lid', $(e.currentTarget).data('lid'));
     }else if (action == 'teacher') {
       $('#removeBody').html('Вы действительно ходите удалить преподавателя <b>' + $(e.currentTarget).data('name') + '</b>?');
       if(data.lessons > 0) $('#removeBody').html($(
         '#removeBody').html() + ' Так же будет ' + getEnding(data.lessons, ['удалён','удалено','удалено']) +' <b>'
         + data.lessons + '</b> '+ getEnding(data.lessons, ['связанный урок','связанных урока','связанных уроков'])
         + ' из списка уроков' + ((data.schedules > 0) ? (' и <b>' + data.schedules + '</b> ' + getEnding(data.schedules, ['урок','урока','уроков']) +' из расписания.') : '.'));
       $('#removeSubmit').attr('data-tid', $(e.currentTarget).data('tid'));
     }else if(action == 'student'){
       $('#removeBody').html('Вы действительно ходите удалить студента <b>' + $(e.currentTarget).data('name') + '</b>?');
       $('#removeSubmit').attr('data-sid', $(e.currentTarget).data('sid'));
     }else {
       setTimeout(function () {
         $('#removeModal').modal('hide');
       }, 500);
       showError(0, true, 'Какая-то ошибка');
       return false;
     }
     $('#removeBody').slideDown('fast');
   }, "json").fail(function(data) {

     setTimeout(function () {
       $('#removeModal').modal('hide');
     }, 500);
     showError(data.status, false);
     return false;
   });

});
$('#removeSubmit').on('click', function(e) {
  var action = $(this).data('action');
  if(action != 'group'){
    $('#removeSubmit').text("Удаление...");
    $('#removeSubmit').prop('disabled', true);
    $.post("/proc/headman.php", { action: 'remove', tid: $('#removeSubmit').attr('data-tid'), lid: $('#removeSubmit').attr('data-lid'), sid: $('#removeSubmit').attr('data-sid')},
     function(data) {
       location.reload();
     }, "json").fail(function(data) {
       if(data.status == 400){
         data.responseJSON.errors.forEach(error => {
           switch (error.error_code) {
             default:{
               setTimeout(function () {
                 $('#removeModal').modal('hide');
               }, 500);
               showError(data.status, false);
             }break;
           }
         });
       }else {
         setTimeout(function () {
           $('#removeModal').modal('hide');
         }, 500);
         showError(data.status, false, false, (data.status == 500)? data.responseJSON.error_text: '');
       }
       return false;
     }).always(function() {
       $('#removeSubmit').text("Удалить");
       $('#removeSubmit').prop('disabled', false);
      });
  }
});
$('#saveTeacherChanges').on('click', function(e) {
  var action = $(this).data('action');
  $("#inputTName").removeClass('is-invalid');
  $("#inputTEmail").removeClass('is-invalid');
  $("#inputTPhone").removeClass('is-invalid');

  $('#saveTeacherChanges').html("Загрузка...");
  $('#saveTeacherChanges').prop('disabled', true);
  $('#inputTName').prop('disabled', true);
  $('#inputTEmail').prop('disabled', true);
  $('#inputTPhone').prop('disabled', true);
  $.post("/proc/headman.php", { action: 'teacher', tid: $('#saveTeacherChanges').attr('data-tid'), name: $('#inputTName').val()
  , email: $('#inputTEmail').val(), phone: $('#inputTPhone').val(), isCurator: $('#isCurator').prop('checked')},
   function(data) {
     $('#TeacherModal').modal('hide');
     location.reload();
   }, "json").fail(function(data) {
     if(data.status == 400){
       data.responseJSON.errors.forEach(error => {
         switch (error.error_code) {
           case 1:{
             $("#invalidTName").html(error.text);
             $("#inputTName").addClass("is-invalid");
           }break;
           case 2:{
             $("#invalidTPhone").html(error.text);
             $("#inputTPhone").addClass("is-invalid");
           }break;
           case 3:case 4:{
             $("#invalidTEmail").html(error.text);
             $("#inputTEmail").addClass("is-invalid");
             if (error.error_code == 4) $("#inputTEmail").prop('value', $("#inputTEmail").prop('value').replaceAll(" ",""));
           }break;
           case 5:{
             $("#invalidTName").html(error.text);
             $("#inputTName").addClass("is-invalid");
           }break;
           default:{
             setTimeout(function () {
               $('#TeacherModal').modal('hide');
             }, 500);
             showError(data.status, false);
           }break;
         }
       });
     }else {
       setTimeout(function () {
         $('#TeacherModal').modal('hide');
       }, 500);
       showError(data.status, false, false, (data.status == 500)? data.responseJSON.error_text: '');
     }
     return false;
   }).always(function() {
     $('#saveTeacherChanges').html((action == 'add')?'Добавить':'Изменить');
     $('#saveTeacherChanges').prop('disabled', false);
     $('#inputTName').prop('disabled', false);
     $('#inputTEmail').prop('disabled', false);
     $('#inputTPhone').prop('disabled', false);
     $('#isCurator').prop('disabled', false);
    });
});
$('.action-teacher').on('click', function(e) {
  var action = $(this).data('action');
  $('#inputTName').val('');
  $('#inputTEmail').val('');
  $('#inputTPhone').val('');
  $('#isCurator').prop('checked',false);
  $("#inputTName").removeClass('is-invalid');
  $("#inputTEmail").removeClass('is-invalid');
  $("#inputTPhone").removeClass('is-invalid');
  $("#inputTPhone").mask("+7(999)999-99-99");
  $('#saveTeacherChanges').attr('data-tid', '-1');
  $('#saveTeacherChanges').attr('data-action', action);
  $('#modalTeacherLabel').text(((action == 'add')?'Добавляем':'Редактируем') + ' учителя');
  $('#saveTeacherChanges').text((action == 'add')?'Добавить':'Изменить');
  setTimeout(function () {
    $('#inputTName').focus();
  }, 500);
  if(action == 'edit'){
    $('#saveTeacherChanges').attr('data-tid', $(this).data('tid'));
    $('#saveTeacherChanges').html("Загрузка...");
    $('#saveTeacherChanges').prop('disabled', true);
    $('#inputTName').prop('disabled', true);
    $('#inputTEmail').prop('disabled', true);
    $('#inputTPhone').prop('disabled', true);
    $('#teacherBody').slideUp('fast');
    $.get("/proc/headman.php", { action: 'loadTeacher', tid: $(e.currentTarget).data('tid')},
     function(data) {
       $('#inputTName').val(data.name);
       $('#inputTEmail').val(data.email);
       $('#inputTPhone').val(data.phone);
       $('#isCurator').prop('checked',data.isCurator);
       $('#teacherBody').slideDown('fast');
     }, "json").fail(function(data) {
       console.error(data);
       setTimeout(function () {
         $('#removeModal').modal('hide');
       }, 500);
       showError(data.status, false);
       return false;
     }).always(function() {
       $('#saveTeacherChanges').html((action == 'add')?'Добавить':'Изменить');
       $('#saveTeacherChanges').prop('disabled', false);
       $('#inputTName').prop('disabled', false);
       $('#inputTEmail').prop('disabled', false);
       $('#inputTPhone').prop('disabled', false);
       $('#isCurator').prop('disabled', false);
      });
  }
});
$('.action-student').on('click', function(e) {
  var action = $(this).data('action');
  $('#saveStudentChanges').prop('disabled', false);
  $('#saveStudentChanges').html((action == 'add')?'Добавить':'Изменить');
  $("#resendInfo").addClass("collapse");
  $('#inputSName').prop('disabled', false);
  $('#inputSEmail').prop('disabled', false);
  $('#inputSName').val('');
  $("#inputSName").removeClass("is-invalid");
  $('#inputSEmail').val('');
  $("#inputSEmail").removeClass("is-invalid");
  $('#saveStudentChanges').attr('data-action', action);
  $('#saveStudentChanges').attr('data-sid', ($(this).data('sid')) ? $(this).data('sid') : '-1');
  $('#modalStudentLabel').text((action == 'add')?'Добавляем студента':'Редактируем студента');
  if(action == 'edit'){
    $('#inputSName').val($(this).data('name'));
    $('#inputSEmail').val($(this).data('email'));
    $("#resendInfo").removeClass("collapse");
  }
  setTimeout(function () {
    $('#inputSName').focus();
  }, 500);
});
$('#saveStudentChanges').on('click', function(e) {
  var action = $(this).data('action');
  $("#inputSName").removeClass("is-invalid");
  $("#inputSEmail").removeClass("is-invalid");
  $('#saveStudentChanges').html("Загрузка...");
  $('#saveStudentChanges').prop('disabled', true);
  $('#inputSName').prop('disabled', true);
  $('#inputSEmail').prop('disabled', true);
  $.post("/proc/headman.php", { action: 'sendInvite', sid: $('#saveStudentChanges').attr('data-sid'), name: $('#inputSName').val(), email: $('#inputSEmail').val()},
   function(data) {

     setTimeout(function () {
       $('#StudentModal').modal('hide');
     }, 500);
     location.reload();
   }, "json").fail(function(data) {
     if(data.status == 400){
       data.responseJSON.errors.forEach(error => {
         switch (error.error_code) {
           case 1:{
             $("#invalidSName").html(error.text);
             $("#inputSName").addClass("is-invalid");
           }break;
           case 2:{
             $("#invalidSEmail").html(error.text);
             $("#inputSEmail").addClass("is-invalid");
           }break;
           default:{
             setTimeout(function () {
               $('#StudentModal').modal('hide');
             }, 500);
             showError(data.status, false);
           }break;
         }
       });
     }else {
       setTimeout(function () {
         $('#StudentModal').modal('hide');
       }, 500);
       showError(data.status, false);
     }
     return false;
   }).always(function() {
     $('#saveStudentChanges').html((action == 'add')?'Добавить':'Изменить');
     $('#saveStudentChanges').prop('disabled', false);
     $('#inputSName').prop('disabled', false);
     $('#inputSEmail').prop('disabled', false);
    });

});
