function showError(status, reload = false, title=false, body = false) {
  if (title) {
    $('#errorModalLabel').html(title);
  }
  switch (status) {
    case 401:var body = "Сессия окончена. Авторизуйся заново.<br>Сейчас я перезагружу страницу...";break;
    default:var body = (body)?body:"Что-то пошло не так!";break;
  }
  $('#errorBody').html($('#errorBody').html() + body);
  $('#errorModal').modal({
    keyboard: false
  });
  $('#errorModal').modal('show');
  if (reload) {
    setTimeout(function () {
      window.location.href = "/profile";
    }, 5000);
  }
}
var onloadCallback = function() {
  grecaptcha.render(document.getElementById('g-recaptcha'), {
    'sitekey' : '6LdH-ncUAAAAAACUBtqP4kbw9gesrdk_58y6ME7k'
  });
};
function $_GET(key) {
  var p = window.location.search;
  p = p.match(new RegExp(key + '=([^&=]+)'));
  return p ? p[1] : false;
}
jQuery(document).ready(function () {
  $("#inputPhone").mask("+7(999)999-99-99");
  setTimeout(function () {
    $('#inputLogin').focus();
  }, 500);
});
$('#registrationBtn').on('click', function(e) {
  $("#inputName").removeClass('is-invalid');
  $("#inputEmail").removeClass('is-invalid');
  $("#inputLogin").removeClass('is-invalid');
  $("#inputPhone").removeClass('is-invalid');
  $("#inputFPassword").removeClass('is-invalid');
  $("#inputSPassword").removeClass('is-invalid');
  $("#inputGender").removeClass('is-invalid');
  $("#inputBirth").removeClass('is-invalid');
  $("#gridCheck").removeClass('is-invalid');
  $("#invalidCaptcha").addClass('collapse');

  $('#inputName').prop('disabled', true);
  $('#inputEmail').prop('disabled', true);
	$('#inputLogin').prop('disabled', true);
	$('#inputPhone').prop('disabled', true);
	$('#inputFPassword').prop('disabled', true);
	$('#inputSPassword').prop('disabled', true);
  $('#inputGender').prop('disabled', true);
	$('#inputBirth').prop('disabled', true);
	$('#gridCheck').prop('disabled', true);
  $('#registrationBtn').prop('disabled', true);
  $('#registrationBtn').html('Загрузка...');
  let datas = {
    name: $("#inputName").val().trim(),
    email: $("#inputEmail").val().trim(),
    login: $("#inputLogin").val().trim(),
    phone: $("#inputPhone").val().trim(),
    fpass: $("#inputFPassword").val().trim(),
    spass: $("#inputSPassword").val().trim(),
    gender: $("#inputGender").val().trim(),
    check: $("#gridCheck").prop('checked'),
    recaptcha: grecaptcha.getResponse(),
    token: $_GET('token')
  };
  if($("#inputBirth").val()) datas['birth'] = $("#inputBirth").val().trim();
  $.post("/proc/reg.php",  datas ,
   function(data) {
     $('div.card-box').slideUp('fast');
     setTimeout(function () {
       $('div.card-box').remove();
     }, 500);

     $('#finishRegistration').modal({
       keyboard: false
     });
     $('#finishRegistration').modal('show');
   }, "json").fail(function(data) {
     grecaptcha.reset(document.getElementById('g-recaptcha'), {
          'sitekey' : '6LdH-ncUAAAAAACUBtqP4kbw9gesrdk_58y6ME7k'
        });
     if(data.status == 400){
       data.responseJSON.errors.forEach(error => {
         switch (error.error_code) {
           case 1:{
             $("#invalidName").html(error.text);
             $("#inputName").addClass("is-invalid");
             $("#inputName").focus();
           }break;
           case 2:case 3:{
             $("#invalidEmail").html(error.text);
             $("#inputEmail").addClass("is-invalid");
             if (error.error_code == 3) $("#inputEmail").prop('value', $("#inputEmail").prop('value').replaceAll(" ",""));
             $("#inputEmail").focus();
           }break;
           case 4:{
             $("#invalidLogin").html(error.text);
             $("#inputLogin").addClass("is-invalid");
             $("#inputLogin").focus();
           }break;
           case 5:{
             $("#invalidPhone").html(error.text);
             $("#inputPhone").addClass("is-invalid");
             $("#inputPhone").focus();
           }break;
           case 6:case 7:{
             $("#invalidFPassword").html(error.text);
             $("#inputFPassword").addClass("is-invalid");
             if (error.error_code == 7) {
               $("#inputFPassword").prop('value', $("#inputFPassword").prop('value').replaceAll(" ",""));
               $("#inputSPassword").prop('value', $("#inputSPassword").prop('value').replaceAll(" ",""));
             }
           }break;
           case 8:{
             $("#invalidSPassword").html(error.text);
             $("#inputSPassword").addClass("is-invalid");
           }break;
           case 9:{
             $("#invalidGender").html(error.text);
             $("#inputGender").addClass("is-invalid");
           }break;
           case 10:{
             $("#invalidBirth").html(error.text);
             $("#inputBirth").addClass("is-invalid");
           }break;
           case 11:{
             $("#gridCheck").addClass("is-invalid");
           }break;
           case 12:{
             $("#invalidCaptcha").html(error.text);
             $("#invalidCaptcha").removeClass('collapse');
           }break;
           default:{
             setTimeout(function () {
               $('#editScheduleModal').modal('hide');
             }, 500);
             showError(data.status, false);
           }break;
         }
       });
     }else {
       showError(data.status, false);
     }
     return false;
   }).always(function() {
     $('#inputName').prop('disabled', false);
     $('#inputEmail').prop('disabled', false);
   	 $('#inputLogin').prop('disabled', false);
   	 $('#inputPhone').prop('disabled', false);
   	 $('#inputFPassword').prop('disabled', false);
   	 $('#inputSPassword').prop('disabled', false);
     $('#inputGender').prop('disabled', false);
   	 $('#inputBirth').prop('disabled', false);
   	 $('#gridCheck').prop('disabled', false);
     $('#registrationBtn').prop('disabled', false);
     $('#registrationBtn').html('Регистрация');
    });
  return false;
});
$('#gridCheck').on('click', function(e) {
	if($('#gridCheck').prop("checked") !== false){
		$('#gridCheck').prop("checked", false);
		$('#termsOfUseModal').modal('show');
	}
});
$('#acceptTerms').on('click', function(e) {
	$('#gridCheck').prop("checked", true);
	$('#termsOfUseModal').modal('hide');
});
